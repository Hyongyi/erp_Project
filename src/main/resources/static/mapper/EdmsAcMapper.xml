<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.choongang.erpproject.edms.mapper.AcMapper">

    <select id="selectList" resultType="AcResponseDto">
        SELECT maj_code, exp_num, exp_title, appl_date, appr_state
        FROM expreport
        GROUP BY exp_num ORDER BY exp_num DESC
    </select>

    <select id="selectDetail" parameterType="String" resultType="AcResponseDto">
        select exp_num,emp_table.emp_name, appr, pstn_code.job_name, hdqrt_code.hq_name, dep_code.dep_name , appl_date, exp_title, att_file, appr_state, det_code, remk, com_acc, expense, appr_date
        FROM expreport
            INNER JOIN emp_table ON expreport.emp_id = emp_table.emp_id
            INNER JOIN pstn_code ON pstn_code.job_code = emp_table.job_code
            INNER JOIN hdqrt_code ON hdqrt_code.hq_code = emp_table.hq_code
            INNER JOIN dep_code ON dep_code.dep_no = emp_table.dep_no
        WHERE exp_num = #{expNum};
    </select>

    <select id="selectAcList" resultType="AcResponseDto">
        SELECT hdqrt_code.hq_name,dep_code.dep_name,pstn_code.job_name, emp_name
        FROM emp_table as aa
                 INNER JOIN pstn_code ON pstn_code.job_code = aa.job_code
                 INNER JOIN hdqrt_code ON hdqrt_code.hq_code = aa.hq_code
                 INNER JOIN dep_code ON dep_code.dep_no = aa.dep_no
        WHERE aa.auth_code = "SJAU_0004" and aa.res_yn="n"
    </select>

    <select id="selectWriter" resultType="AcResponseDto">
        SELECT emp_id, emp_name, hdqrt_code.hq_name, dep_code.dep_name
        FROM emp_table as bb
                 INNER JOIN hdqrt_code ON hdqrt_code.hq_code = bb.hq_code
                 INNER JOIN dep_code ON dep_code.dep_no = bb.dep_no
        WHERE bb.emp_id = #{empId}
    </select>

    <!--안쓰임-->
    <insert id="insert" parameterType="AcRequestDto">
        INSERT INTO expreport (exp_title,det_code, remk, com_acc,expense,exp_num,appr,appl_date,maj_code)
        VALUES (#{expTitle},#{detCode},#{remk},#{comAcc},#{expense},#{expNum},#{appr},now(),"회계")
    </insert>

    <insert id="insertList" parameterType="List">
        INSERT INTO expreport (exp_title,det_code, remk, com_acc,expense,appr,appl_date,maj_code,att_file,emp_id)
        VALUES
            <foreach collection="list" separator="," item="ac">
            (#{ac.expTitle},#{ac.detCode},#{ac.remk},#{ac.comAcc},#{ac.expense},#{ac.appr},now(),"회계",#{ac.attFile},#{ac.empId})
            </foreach>
    </insert>

    <update id="updateExpNum" parameterType="List">
        update expreport
        set exp_num  = (SELECT concat("SJCD-",LPAD((MAX(CONVERT(SUBSTRING(exp_num,6,10),signed integer)))+1,4,0)) from
                (SELECT * from expreport) as a)
        where exp_num is null
    </update>

    <update id="update" parameterType="AcRequestDto">
        UPDATE expreport
        SET appr_state = #{apprState}, appr_date = #{apprDate}
        WHERE exp_num = #{expNum}
    </update>

</mapper>

